name: Build the Reference FMUs

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  FMPY: https://github.com/CATIA-Systems/FMPy/archive/d9547792af143b9e25f23073cb44a327289e0f5e.zip
  CONDA_PACKAGES: dask lark-parser lxml numpy pathlib pip pytest requests scipy

jobs:

  lint-files:

    runs-on: ubuntu-18.04

    steps:
    - uses: actions/checkout@v3

    - name: Lint files
      run: python3 lint_files.py

  clang-format-check-files:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Clang format check files
      uses: DoozyX/clang-format-lint-action@v0.14
      with:
        source: 'examples BouncingBall Clocks Dahlquist Feedthrough LinearTransform Resource Stair VanDerPol'
        extensions: 'c,h'
        clangFormatVersion: 14
        inplace: False

  clang-format-files:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Clang format files
      uses: DoozyX/clang-format-lint-action@v0.14
      with:
        source: 'examples BouncingBall Clocks Dahlquist Feedthrough LinearTransform Resource Stair VanDerPol'
        extensions: 'c,h'
        clangFormatVersion: 14
        inplace: True

    - name: Upload Clang formatted files
      uses: actions/upload-artifact@v3
      with:
        name: clang-formatted-files
        path: |
          examples/*.c
          BouncingBall/*.c
          Clocks/*.c
          Dahlquist/*.c
          Feedthrough/*.c
          LinearTransform/*.c
          Resource/*.c
          Stair/*.c
          VanDerPol/*.c
          examples/*.h
          BouncingBall/*.h
          Clocks/*.h
          Dahlquist/*.h
          Feedthrough/*.h
          LinearTransform/*.h
          Resource/*.h
          Stair/*.h
          VanDerPol/*.h

  build-linux:

    runs-on: ubuntu-18.04
    needs: lint-files

    steps:
    - uses: actions/checkout@v3

    - name: Check python version
      run: |
        python --version

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'

    - name: Add conda to system path
      run: |
        echo $CONDA/bin >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        conda install --channel conda-forge $CONDA_PACKAGES
        python -m pip install --no-deps $FMPY

    - name: Run tests
      run: |
        pytest -s -v --junitxml=junit/test-results.xml

    - name: Upload FMUs
      uses: actions/upload-artifact@v3
      with:
        name: Linux-FMUs
        path: fmus
        if-no-files-found: error

  build-windows:

    runs-on: windows-2022
    needs: lint-files

    steps:
    - uses: actions/checkout@v3

    - name: Check python version
      run: |
        python --version

    - name: Install dependencies
      run: |
        python -m pip install $env:FMPY pytest scipy

    - name: Run tests
      run: |
        pytest -s -v --junitxml=junit/test-results.xml

    - name: Upload FMUs
      uses: actions/upload-artifact@v3
      with:
        name: Windows-FMUs
        path: fmus
        if-no-files-found: error

  build-macos:

    runs-on: macos-10.15
    needs: lint-files

    steps:
    - uses: actions/checkout@v3

    - name: Check python version
      run: |
        python --version

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'

    - name: Add conda to system path
      run: |
        echo $CONDA/bin >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        conda install --channel conda-forge $CONDA_PACKAGES
        python -m pip install --no-deps $FMPY

    - name: Run tests
      run: |
        pytest -s -v --junitxml=junit/test-results.xml

    - name: Upload FMUs
      uses: actions/upload-artifact@v3
      with:
        name: macOS-FMUs
        path: fmus
        if-no-files-found: error

  merge-fmus:

    runs-on: ubuntu-18.04
    needs: [build-linux, build-windows, build-macos]

    steps:

    - uses: actions/checkout@v3

    - uses: actions/download-artifact@v3
      with:
        name: Linux-FMUs
        path: fmus

    - uses: actions/download-artifact@v3
      with:
        name: macOS-FMUs
        path: fmus

    - uses: actions/download-artifact@v3
      with:
        name: Windows-FMUs
        path: fmus

    - name: Merge FMUs
      run: |
        python3 merge_platform_binaries.py

    - name: Upload FMUs
      uses: actions/upload-artifact@v3
      with:
        name: merged-FMUs
        path: merged
        if-no-files-found: error
